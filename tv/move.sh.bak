#!/bin/bash

#move.sh - 

#makes it so that array elements are only separated
# on new lines, not spaces
#IFS='
#'

#extended pattern matching
shopt -s extglob

function usage {
	echo "usage: $0 [directory]"
}

#if args exist, use them. If not, use the supplied data
downDir="/home/ubuntu/Downloads/"
tvDir="/home/ubuntu/Videos/TV/"
if [[ $# = 1 ]]; then
	downDir=$1
elif [[ $# > 1 ]]; then
        usage
        exit 0
fi
 

#output in case of errors
output="/home/ubuntu/move`date +%m%d%y`.log"
#Set the name of the weekly folder
monday=$[`date -d monday +%s`-7*24*60*60]
monday=`date -d @$monday +%m%d%y%H%M%S`
#Store Current Directory and change to downloads folder
curDir=`pwd`
cd "$downDir"

#copies to the show dir, then moves into the weekly folder
#function cpmv {
#	#if season doesn't already exist, create
#	if ! [[ -d $folder ]]; then
#		echo "mkdir -p $folder"
#	fi
#	echo "cp -v $file $folder"
#	if ! [[ -d $monday ]]; then
#		echo "mkdir $monday"
#	fi
#	echo "mv $file $monday"
#}


function testcpmv {
	#if season doesn't already exist, create
	if ! [[ -d $folder ]]; then
		echo "mkdir -p $folder"
	fi
	echo "cp -v $file $folder"
	if ! [[ -d $monday ]]; then
		echo "mkdir $monday"
	fi
	echo "mv $file $monday"
}

#checks for the correct pattern
function patt {
	flag=false
	if [[ "$file" == *S?([1-9])@([0-9])E* ]]; then
		flag=true
	fi
}

#checks that the show name is in the list of shows we already have
#if it is, make this the copy dir
function series {
	flag=false
	s="${file%% S?([1-9])@([0-9])E@([0-9])@([0-9])*}"
	for j in "${path[@]}"; do
	    f="${j##*/}"
		if [[ "$s" == "$f" ]]; then
			flag=true
			copy="$j"
			break
		fi
	done
}

function season {
	s=${file%%E@([0-9])@([0-9])*}
	s=${s##* S}
	if [[ $s -lt 10 ]]; then
		s="0"$s 
	fi
	copy="$copy/Season $s/"
}

function mythbusters {
	flag=false
	if [[ "$file" == "MythBusters"* ]]; then
		s="Mythbusters"
		for j in ${path[@]}; do
    			f="${j##*/}"
	    		if [[ "$s" == "$f" ]]; then
	    			flag=true
	    			copy="$j"
	    			break
	    		fi 
	 	done
		year=`date +%Y`
		copy="$copy/$year/"
	fi
}

#Show list
x=0
for i in "$tvDir"*;
do
	path[$x]="$i"
	(( x++ ))
done

#Go through list and sort
for i in *;
do
	file=$i
	copy=""
	mythbusters
	if $flag; then
		echo -e "$file is a Mythbusters episode"
	else
		patt
		if $flag; then
		    series
		fi
		if $flag; then
		    season
		fi
#		if $flag; then
#		    cpmv
#		fi
	fi
	echo "$file - $flag - $copy"
done
cd "$curDir"

